<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="{{url_for('static', filename = 'css/main.css')}}">
    <title>Flask - SocketIO></title>
  </head>
  <body>
    <div id="app">
      <div v-if="state == 0">
        <h3>Welcome! Please choose a username</h3>
        <form @submit.prevent="setUsername">
          <input type="text" placeholder="Username..." v-model:value="username" />
          <input type="submit" value="Join" />
        </form>
        <button @click="continueWithoutUsername">Join as a Guest</button>
      </div>
      <div v-if="state == 1">
            <ul id="chatbox">
              <li v-for="message in messages">
                <b>[[ message.user ]]:</b> [[ message.message ]]
              </li>
            </ul>
            <form @submit.prevent="sendMessage">
            <input type="text" placeholder="Message..." v-model:value="message" />
            <input type="submit" value="Send" />
            </form>

      </div>
    </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.13/vue.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
        <script type="text/javascript" charset="utf-8">
          var socket = io.connect('http://' + document.domain + ':' + location.port);
          socket.on('my event', function() {
            socket.send('User connected')
          });
          var app = new Vue({
            // State 0 for username selection
            // State 1 for chat
            el: '#app',
            data: {
              messages: [],
              message: '',
              username: '',
              state: 0
            },
            delimeters: ["[[", "]]"],
              methods: {
              sendMessage: function() {
                socket.emit('message', 'this.message');
                this.message='';
              },
              setUsername: function() {
                socket.emit('join', null);
                this.state=1;
              },
              continueWithoutUsername: function() {
                socket.emit('join', null);
                this.state=1;
              }
            },

            mounted: function() {
              socket.on('message', function(message) {
                app.messages.push(message);
                app.$nextTick(function() {
                  var messageBox = document.getElementById('chatbox');
                  messageBox.scrolltop=messageBox.scrollHeight;
                });
              });
            }
          });
      </script>
  </body>
</html>
