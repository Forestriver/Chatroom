<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="{{url_for('static', filename = 'css/main.css')}}">
    <title>Hobby chat rooms</title>
  </head>
  <body>
      <div class="background">
          <div id="app">
              <div class="container" id="setUsername">
                  <div v-if="state == 0">
                    <h2>Welcome to this chat! Please choose a username</h2>
                    <form @submit.prevent="setUsername">
                      <input type="text" placeholder="Username..." maxlength="25" v-model:value="username" />
                      <p><input type="submit" value="Join"/></p>
                    </form>
                  </div>
              </div>
              <div class="container" id="chat">
                  <div v-if="state == 1">
                      <ul id="chatbox">
                        <li v-for="msg in this.messages">
                          <b>[[ msg.user ]]</b> : [[ msg.message ]]
                        </li>
                      </ul>
                      <form @submit.prevent="sendMessage">
                      <input type="text" maxlength="590" size="75" placeholder="Message..." v-model:value="message" />
                      <div><input type="submit" value="Send" /></div>
                      </form>
                  </div>
              </div>
          </div>
      </div>

            <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.13/vue.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
            <script type="text/javascript" charset="utf-8">
              var socket = io.connect('http://' + document.domain + ':' + location.port);
              socket.on('my event', function() {
                socket.send('User connected')
              });

              Vue.config.devtools = true;
              Vue.options.delimiters = ['[[', ']]'];
              // Vue.prototype.$log = console.log;

              var app = new Vue({
                // State 0 for username selection
                // State 1 for chat
                el: '#app',
                data: {
                  messages: [],
                  message: '',
                  username: '',
                  state: 0
                },
                // delimeters: ["${", "}"],
                  methods: {
                  sendMessage: function() {
                    socket.emit('message', {"user": this.username, "message": this.message});
                    this.message='';
                  },
                  setUsername: function() {
                    socket.emit('join', this.username);
                    this.state=1;
                  },
                },

                mounted: function() {
                  socket.on('message', function(message) {
                    app.messages.push(message);
                    app.$nextTick(function() {
                      var messageBox = document.getElementById('chatbox');
                      messageBox.scrolltop=messageBox.scrollHeight;
                    });
                  });
                  socket.on('username', function(username) {
                    app.messages.push(username)
                  });
                }
              });
            </script>
  </body>
</html>
